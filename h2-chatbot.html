<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydrogen Energy Chatbot</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for accessibility and feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .chat-container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 100%;
            max-width: 600px; /* Max width for desktop */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 85vh; /* Responsive height */
            max-height: 800px;
        }

        .chat-header {
            background-color: #007bff; /* Blue header */
            color: white;
            padding: 1.5rem;
            text-align: center;
            font-size: 1.75rem;
            font-weight: 700;
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            display: flex; /* Use flexbox for alignment */
            align-items: center; /* Vertically center items */
            justify-content: center; /* Horizontally center items */
            gap: 10px; /* Space between logo and title */
        }

        .h2-logo-container {
            width: 40px; /* Size of the logo */
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .h2-logo-container svg {
            fill: white; /* Color of the SVG */
            width: 100%;
            height: 100%;
        }

        .chat-messages {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        .chat-messages::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .message-bubble {
            max-width: 80%;
            padding: 0.8rem 1.2rem;
            border-radius: 1.25rem; /* More rounded bubbles */
            word-wrap: break-word;
            line-height: 1.5;
        }

        .user-message {
            background-color: #e0f2fe; /* Light blue for user */
            align-self: flex-end;
            color: #333;
            border-bottom-right-radius: 0.25rem; /* Pointy corner */
        }

        .bot-message {
            background-color: #f1f5f9; /* Light grey for bot */
            align-self: flex-start;
            color: #333;
            border-bottom-left-radius: 0.25rem; /* Pointy corner */
        }

        /* Styles for lists within bot messages */
        .bot-message ul,
        .bot-message ol {
            margin-top: 0.5rem;
            margin-bottom: 0;
            padding-left: 1.5rem; /* Indent lists */
            list-style: none; /* Remove default bullet */
        }

        .bot-message ul li {
            margin-bottom: 0.25rem;
            position: relative;
            padding-left: 1.2em; /* Space for custom tick */
        }

        .bot-message ul li::before {
            content: 'âœ“'; /* Tick mark as bullet */
            position: absolute;
            left: 0;
            color: #007bff; /* Blue tick mark */
            font-weight: bold;
        }

        .bot-message ol li {
            margin-bottom: 0.25rem;
        }


        .chat-input-area {
            display: flex;
            padding: 1.5rem;
            border-top: 1px solid #e2e8f0;
            background-color: #f8fafc;
        }

        .chat-input {
            flex-grow: 1;
            padding: 1rem 1.25rem;
            border: 1px solid #cbd5e1;
            border-radius: 1.5rem;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
            margin-right: 1rem;
        }

        .chat-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        .send-button {
            background-color: #007bff;
            color: white;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 1.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
        }

        .send-button:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }

        .send-button:active {
            transform: translateY(1px);
        }

        .send-button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
        }

        .loading-indicator {
            align-self: flex-start;
            padding: 0.8rem 1.2rem;
            border-radius: 1.25rem;
            background-color: #e2e8f0;
            color: #64748b;
            font-style: italic;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .chat-footer {
            padding: 1rem;
            text-align: center;
            font-size: 0.875rem; /* Small text for copyright */
            color: #64748b; /* Grey text */
            background-color: #f8fafc;
            border-top: 1px solid #e2e8f0;
            border-bottom-left-radius: 1.5rem;
            border-bottom-right-radius: 1.5rem;
        }


        /* Responsive adjustments */
        @media (max-width: 640px) {
            .chat-container {
                height: 95vh;
                border-radius: 0.75rem;
            }
            .chat-header {
                font-size: 1.5rem;
                padding: 1rem;
                border-top-left-radius: 0.75rem;
                border-top-right-radius: 0.75rem;
            }
            .chat-messages {
                padding: 1rem;
                gap: 0.75rem;
            }
            .message-bubble {
                padding: 0.6rem 1rem;
                border-radius: 1rem;
            }
            .chat-input-area {
                padding: 1rem;
                flex-direction: column;
                gap: 0.75rem;
            }
            .chat-input {
                margin-right: 0;
                padding: 0.8rem 1rem;
            }
            .send-button {
                padding: 0.8rem 1.2rem;
                width: 100%;
            }
            .chat-footer {
                padding: 0.75rem;
                font-size: 0.75rem;
                border-bottom-left-radius: 0.75rem;
                border-bottom-right-radius: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container" role="main" aria-label="Hydrogen Energy Chatbot">
        <header class="chat-header">
            <div class="h2-logo-container" role="img" aria-label="H2 Hydrogen Logo">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-12h4v2h-2v4h-2v-4h-2V6zm4 8h-4v2h4v-2z"/>
                    <text x="7" y="14" font-family="Arial, sans-serif" font-size="7" fill="white" font-weight="bold">H</text>
                    <text x="11.5" y="16.5" font-family="Arial, sans-serif" font-size="4" fill="white">2</text>
                </svg>
            </div>
            <h1>Hydrogen Energy Chatbot</h1>
        </header>
        <div id="chat-messages" class="chat-messages" role="log" aria-live="polite">
            <!-- Initial greeting will be added by JavaScript based on LLM persona -->
        </div>
        <div class="chat-input-area">
            <label for="user-input" class="sr-only">Type your message here</label>
            <input type="text" id="user-input" class="chat-input" placeholder="Ask about hydrogen..." aria-label="Chat input field">
            <button id="send-button" class="send-button" aria-label="Send message">Send</button>
        </div>
        <footer class="chat-footer" role="contentinfo">
            Made by Nabil with help of AI
        </footer>
    </div>

    <script type="module">
        // Global variables for Firebase and App ID, required for Firestore interaction if needed.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-hydrogen-chatbot-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        // Initial chat history to instruct the LLM on its persona and response style
        let chatHistory = [
            {
                role: "user",
                parts: [{ text: "You are a Hydrogen Energy Chatbot. Your task is to answer hydrogen-related questions concisely, using simple, human-like words, but ensuring the answers are accurate, to-the-point, and grounded in information typically found in academic articles from top journals and business reports from organizations like IEA, Hydrogen Council, or the UK Government. Always prioritize clear, actionable, and factual information without jargon. Feel free to use bold text (**text**) to highlight key terms or phrases for readability. When appropriate, provide answers in a clear, point-by-point format using a tick mark (âœ“) followed by a space, for example: 'âœ“ First point'. Be helpful and informative." }]
            },
            {
                role: "model",
                parts: [{ text: "Hello! I'm your Hydrogen Energy Chatbot. I can provide concise, human-friendly answers about hydrogen, drawing from reliable academic and industry sources, often in a clear point-by-point format using tick marks. How can I help you today?" }]
            }
        ];

        // Append the initial bot message to the UI
        appendMessage(chatHistory[1].parts[0].text, 'bot');

        /**
         * Appends a message bubble to the chat interface.
         * @param {string} message - The text content of the message.
         * @param {string} sender - 'user' or 'bot' to determine styling.
         * @param {boolean} isLoading - True if it's a loading indicator.
         */
        function appendMessage(message, sender, isLoading = false) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message-bubble');
            messageElement.setAttribute('tabindex', '0'); // Make bubbles focusable for accessibility

            let formattedMessage = message;

            // Handle bold text
            formattedMessage = formattedMessage.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // This is a simplified markdown parser. For complex markdown, a library would be better.
            const lines = formattedMessage.split('\n');
            let htmlContent = '';
            let inUnorderedList = false; // Now for tick-mark lists
            let inOrderedList = false;

            lines.forEach(line => {
                const trimmedLine = line.trim();
                // Match lines starting with a tick mark (âœ“)
                const isTickListItem = trimmedLine.match(/^âœ“\s(.+)$/);
                const isOrderedListItem = trimmedLine.match(/^\d+\.\s(.+)$/);

                if (isTickListItem) {
                    if (!inUnorderedList) {
                        if (inOrderedList) { htmlContent += '</ol>'; inOrderedList = false; }
                        htmlContent += '<ul>'; // Use ul for tick-mark lists
                        inUnorderedList = true;
                    }
                    htmlContent += `<li>${isTickListItem[1]}</li>`;
                } else if (isOrderedListItem) {
                    if (!inOrderedList) {
                        if (inUnorderedList) { htmlContent += '</ul>'; inUnorderedList = false; }
                        htmlContent += '<ol>';
                        inOrderedList = true;
                    }
                    htmlContent += `<li>${isOrderedListItem[1]}</li>`;
                } else {
                    if (inUnorderedList) { htmlContent += '</ul>'; inUnorderedList = false; }
                    if (inOrderedList) { htmlContent += '</ol>'; inOrderedList = false; }
                    if (line.length > 0) {
                        htmlContent += `<p>${line}</p>`;
                    }
                }
            });

            // Close any open lists at the end
            if (inUnorderedList) { htmlContent += '</ul>'; }
            if (inOrderedList) { htmlContent += '</ol>'; }

            messageElement.innerHTML = htmlContent; // Use innerHTML to render bold and list HTML

            if (sender === 'user') {
                messageElement.classList.add('user-message');
            } else if (sender === 'bot') {
                messageElement.classList.add('bot-message');
                if (isLoading) {
                    messageElement.classList.add('loading-indicator');
                    messageElement.setAttribute('aria-label', 'Bot is typing...');
                }
            }
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to the bottom
        }

        /**
         * Handles sending a message: displays user input, calls the API, and displays bot response.
         */
        async function sendMessage() {
            const userMessage = userInput.value.trim();
            if (userMessage === '') {
                return; // Don't send empty messages
            }

            appendMessage(userMessage, 'user');
            userInput.value = ''; // Clear input field
            sendButton.disabled = true; // Disable send button during API call
            userInput.disabled = true; // Disable input field

            // Add user message to chat history
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

            // Display loading indicator
            const loadingBubble = document.createElement('div');
            loadingBubble.classList.add('bot-message', 'message-bubble', 'loading-indicator');
            loadingBubble.textContent = 'Bot is typing...';
            loadingBubble.setAttribute('aria-live', 'assertive');
            loadingBubble.setAttribute('aria-label', 'Bot is typing');
            chatMessages.appendChild(loadingBubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;


            try {
                // Prepare the payload for the Gemini API call
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will provide this key at runtime for gemini-2.0-flash
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} - ${errorData.message || response.statusText}`);
                }

                const result = await response.json();

                // Remove loading indicator
                chatMessages.removeChild(loadingBubble);

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const botResponseText = result.candidates[0].content.parts[0].text;
                    appendMessage(botResponseText, 'bot');
                    // Add bot response to chat history
                    chatHistory.push({ role: "model", parts: [{ text: botResponseText }] });
                } else {
                    appendMessage("Sorry, I couldn't get a response. Please try again.", 'bot');
                }
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                // Remove loading indicator if an error occurred before a response was received
                if (chatMessages.contains(loadingBubble)) {
                    chatMessages.removeChild(loadingBubble);
                }
                appendMessage(`An error occurred: ${error.message}. Please try again later.`, 'bot');
            } finally {
                sendButton.disabled = false; // Re-enable send button
                userInput.disabled = false; // Re-enable input field
                userInput.focus(); // Return focus to input field
            }
        }

        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        // Focus on input field when page loads for better accessibility
        window.onload = () => {
            userInput.focus();
        };
    </script>
</body>
</html>
