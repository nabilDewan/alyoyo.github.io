<!DOCTYPE html>
<!--
  AI‑enabled task management assistant
  This single HTML file provides a lightweight yet powerful dashboard for travel agents
  who need to juggle time‑sensitive ticketing and tour arrangements. It integrates
  with common productivity tools (Gmail, Outlook, Slack and Google Docs), offers
  an AI‑powered chat interface, automatically extracts tasks from your messages
  and documents, prioritises them and reminds you throughout the day. All logic
  is contained in this file so it can be hosted on a static site (e.g. GitHub
  Pages).

  NOTE: You must supply your own API keys and OAuth tokens. See the comments
  throughout the JavaScript for details on how to obtain keys and scopes. Refer
  to the Google documentation to enable the Gmail API and obtain a client ID and
  API key【233546399867807†L462-L474】. For Outlook integration you need a Microsoft
  Graph token with the Mail.Read scope【297183856141940†L59-L68】. Slack
  integration requires a bot or user token with the appropriate history scope
  (e.g. channels:history)【398802050782037†L898-L1003】. Google Docs
  integration calls the documents.get endpoint【690496299547639†L233-L290】.

  Before using the chat module you must generate an OpenAI API key. To get one
  create an account on Platform.OpenAI.com and click Create new secret key in
  the API keys section【500766589795801†L397-L404】. Keep your key private.
-->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Travel Agent AI Task Assistant</title>
  <!-- Bootstrap for layout and components -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" integrity="sha384-MIi8ox2RBhddHBSpAYXKSpfcHbnVudMcZRaPxVe1OCUl0hO61ZTxLBnxmB5T9vbu" crossorigin="anonymous" />
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-zDknVzZVZ3hLQfP5Z9kxaPK8O/RBHQhbRhLr/cTTyapIeiAVDj+5FoqPY0rcK34IHYw4J70WFfN2z4BSgH7tyg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body {
      background-color: #f6f9fc;
      font-family: Arial, Helvetica, sans-serif;
    }
    .nav-link {
      cursor: pointer;
    }
    /* Chat styling */
    #chatMessages {
      height: 350px;
      overflow-y: auto;
      border: 1px solid #ddd;
      background: #fff;
      padding: 1rem;
      border-radius: 0.5rem;
    }
    .message.user {
      text-align: right;
      color: #007bff;
    }
    .message.bot {
      text-align: left;
      color: #333;
    }
    .message {
      margin-bottom: 0.5rem;
    }
    .task-item {
      padding: 0.5rem;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
      background: #fff;
      border: 1px solid #ddd;
    }
    .task-item.done {
      text-decoration: line-through;
      opacity: 0.6;
    }
    /* Notification toast */
    #toastContainer {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 9999;
    }
    .toast-body {
      font-size: 0.9rem;
    }
    /* Integration cards */
    .integration-card {
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      padding: 1rem;
      background: #fff;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Travel Agent AI</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" data-bs-target="#chatTab">AI Chat</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#tasksTab">Tasks</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#integrationsTab">Integrations</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#settingsTab">Settings</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-3">
    <div class="tab-content">
      <!-- Chat Tab -->
      <div class="tab-pane fade show active" id="chatTab">
        <h4>AI Chat Assistant</h4>
        <p>Ask questions about your itineraries, get destination info, or brainstorm tasks. Powered by OpenAI’s GPT models.</p>
        <div id="chatMessages" class="mb-2"></div>
        <div class="input-group">
          <input type="text" id="chatInput" class="form-control" placeholder="Type your message…" />
          <button class="btn btn-primary" id="sendChat"><i class="fa fa-paper-plane"></i> Send</button>
        </div>
      </div>

      <!-- Tasks Tab -->
      <div class="tab-pane fade" id="tasksTab">
      <div class="d-flex justify-content-between align-items-center">
        <h4>Today's Tasks</h4>
        <button class="btn btn-secondary btn-sm" id="summariseTasksBtn"><i class="fa fa-magic"></i> Prioritise with AI</button>
      </div>
        <div class="my-2" id="taskList"></div>
        <form id="addTaskForm" class="row g-2">
          <div class="col-md-5"><input type="text" class="form-control" id="taskTitle" placeholder="Task description" required></div>
          <div class="col-md-3"><input type="datetime-local" class="form-control" id="taskDue"></div>
          <div class="col-md-2">
            <select class="form-select" id="taskPriority">
              <option value="Low">Low</option>
              <option value="Medium" selected>Medium</option>
              <option value="High">High</option>
            </select>
          </div>
          <div class="col-md-2"><button type="submit" class="btn btn-success w-100"><i class="fa fa-plus"></i> Add</button></div>
        </form>
      </div>

      <!-- Integrations Tab -->
      <div class="tab-pane fade" id="integrationsTab">
        <h4>Integrations</h4>
        <p>Connect your services to automatically extract tasks. Each integration requires OAuth authentication and appropriate scopes.</p>
        <div id="integrations" class="row">
          <!-- Gmail -->
          <div class="col-md-6">
            <div class="integration-card">
              <h5><i class="fa fa-envelope"></i> Gmail</h5>
              <p>Fetch emails with labels like “ToDo” or flagged for follow‑up from your Gmail account using the Gmail API. You must enable the Gmail API in the Google Cloud console and create OAuth credentials【233546399867807†L305-L349】.</p>
              <button class="btn btn-outline-primary" id="gmailConnectBtn">Connect Gmail</button>
              <div id="gmailStatus" class="mt-2 text-success d-none">Connected</div>
            </div>
          </div>
          <!-- Outlook -->
          <div class="col-md-6">
            <div class="integration-card">
              <h5><i class="fa fa-envelope-open-text"></i> Outlook/Microsoft 365</h5>
              <p>Read messages from your Outlook inbox using the Microsoft Graph mail API. You need a token with <code>Mail.Read</code> scope to access your emails【297183856141940†L59-L67】.</p>
              <button class="btn btn-outline-primary" id="outlookConnectBtn">Connect Outlook</button>
              <div id="outlookStatus" class="mt-2 text-success d-none">Connected</div>
            </div>
          </div>
          <!-- Slack -->
          <div class="col-md-6">
            <div class="integration-card">
              <h5><i class="fa fa-slack"></i> Slack</h5>
              <p>Fetch messages from selected channels. The <code>conversations.history</code> method of the Slack API requires a bot or user token with the channels:history scope【398802050782037†L898-L1003】. Due to rate limits, consider fetching only specific channels or time ranges【398802050782037†L1090-L1104】.</p>
              <button class="btn btn-outline-primary" id="slackConnectBtn">Connect Slack</button>
              <div id="slackStatus" class="mt-2 text-success d-none">Connected</div>
            </div>
          </div>
          <!-- Google Docs -->
          <div class="col-md-6">
            <div class="integration-card">
              <h5><i class="fa fa-file-word"></i> Google Docs</h5>
              <p>Read the contents of Google Docs to extract action items. Use the Docs API’s <code>documents.get</code> method with an OAuth token and document ID to retrieve the latest content【690496299547639†L233-L290】.</p>
              <button class="btn btn-outline-primary" id="docsConnectBtn">Connect Docs</button>
              <div id="docsStatus" class="mt-2 text-success d-none">Connected</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div class="tab-pane fade" id="settingsTab">
        <h4>Settings</h4>
        <form id="settingsForm" class="row g-3">
          <div class="col-md-6">
            <label for="morningTime" class="form-label">Morning Summary Time</label>
            <input type="time" id="morningTime" class="form-control" />
          </div>
          <div class="col-md-6">
            <label for="updateInterval" class="form-label">Update Interval (minutes)</label>
            <input type="number" id="updateInterval" class="form-control" min="15" max="240" />
          </div>
          <div class="col-12">
            <label for="openaiKey" class="form-label">OpenAI API Key</label>
            <input type="password" id="openaiKey" class="form-control" placeholder="sk-..." />
            <div class="form-text">Create a key at platform.openai.com【500766589795801†L397-L404】 and keep it secret.</div>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary">Save Settings</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast container for notifications -->
  <div id="toastContainer" class="toast-container position-fixed"></div>

  <!-- External scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-BTZ4vIqvrkKaq/rl0D9DEWOCxs1D4R+ZTS96Mn51BicCj00dFxXyDoZpBqUM9JwN" crossorigin="anonymous"></script>
  <!-- Google API scripts loaded on demand during Gmail integration -->
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

  <script>
    /*******************************
     * Settings and state
     *******************************/
    const state = {
      tasks: [],
      openaiKey: '',
      updateInterval: 120, // minutes between midday summaries
      morningTime: '08:00',
      integrationTokens: {
        gmail: null,
        outlook: null,
        slack: null,
        docs: null,
      },
    };

    // Load preferences from localStorage
    function loadPreferences() {
      const saved = localStorage.getItem('aiAssistantPrefs');
      if (saved) {
        Object.assign(state, JSON.parse(saved));
      }
      document.getElementById('openaiKey').value = state.openaiKey || '';
      document.getElementById('morningTime').value = state.morningTime || '08:00';
      document.getElementById('updateInterval').value = state.updateInterval || 120;
    }

    function savePreferences() {
      state.openaiKey = document.getElementById('openaiKey').value;
      state.morningTime = document.getElementById('morningTime').value;
      state.updateInterval = parseInt(document.getElementById('updateInterval').value, 10) || 120;
      localStorage.setItem('aiAssistantPrefs', JSON.stringify({
        openaiKey: state.openaiKey,
        morningTime: state.morningTime,
        updateInterval: state.updateInterval,
      }));
    }

    /*******************************
     * Notification logic
     *******************************/
    // Request permission on load
    if (window.Notification && Notification.permission !== 'granted') {
      Notification.requestPermission();
    }

    // Schedule notifications based on preferences
    function scheduleNotifications() {
      // Clear existing timers
      if (state.morningTimer) clearTimeout(state.morningTimer);
      if (state.updateTimer) clearInterval(state.updateTimer);

      // Calculate next morning summary time
      const [hour, minute] = state.morningTime.split(':').map(Number);
      const now = new Date();
      let next = new Date(now);
      next.setHours(hour, minute, 0, 0);
      if (next <= now) next.setDate(next.getDate() + 1);
      const delay = next - now;
      state.morningTimer = setTimeout(() => {
        showDailySummary();
        // after sending morning summary, schedule next day
        scheduleNotifications();
      }, delay);

      // Midday update interval (in minutes)
      const intervalMs = state.updateInterval * 60 * 1000;
      state.updateTimer = setInterval(() => {
        showDailySummary(true);
      }, intervalMs);
    }

    function showToast(title, message) {
      const toastId = 'toast' + Date.now();
      const toast = document.createElement('div');
      toast.className = 'toast align-items-center text-bg-primary border-0 show';
      toast.id = toastId;
      toast.style.minWidth = '250px';
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            <strong>${title}</strong><br/>${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      document.getElementById('toastContainer').appendChild(toast);
      // Auto remove after 8 seconds
      setTimeout(() => toast.remove(), 8000);
    }

    // Create a notification using the Notification API
    function notify(title, message) {
      if (Notification.permission === 'granted') {
        new Notification(title, { body: message });
      } else {
        showToast(title, message);
      }
    }

    function showDailySummary(isMidday = false) {
      // Sort tasks by priority (High > Medium > Low) and due date
      const sorted = [...state.tasks].filter(t => !t.done).sort((a, b) => {
        const priorityOrder = { High: 0, Medium: 1, Low: 2 };
        if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
          return priorityOrder[a.priority] - priorityOrder[b.priority];
        }
        return new Date(a.due) - new Date(b.due);
      });
      let message;
      if (sorted.length === 0) {
        message = 'You have no pending tasks. Enjoy your day!';
      } else {
        const lines = sorted.slice(0, 5).map(t => `${t.title} (Due: ${t.due ? new Date(t.due).toLocaleString() : 'unspecified'})`);
        message = lines.join('\n');
        if (sorted.length > 5) message += '\n…and more';
      }
      const title = isMidday ? 'Task Update' : 'Morning Summary';
      notify(title, message);
    }

    /*******************************
     * Task management
     *******************************/
    function renderTasks() {
      const list = document.getElementById('taskList');
      list.innerHTML = '';
      state.tasks.sort((a, b) => {
        const priorityOrder = { High: 0, Medium: 1, Low: 2 };
        if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
          return priorityOrder[a.priority] - priorityOrder[b.priority];
        }
        return new Date(a.due || 0) - new Date(b.due || 0);
      });
      state.tasks.forEach((task, index) => {
        const div = document.createElement('div');
        div.className = 'task-item' + (task.done ? ' done' : '');
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>${task.title}</strong>
              <div class="small text-muted">Due: ${task.due ? new Date(task.due).toLocaleString() : 'No due date'} | Priority: ${task.priority}</div>
            </div>
            <div>
              <button class="btn btn-sm btn-outline-success me-1" onclick="toggleDone(${index})"><i class="fa ${task.done ? 'fa-undo' : 'fa-check'}"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${index})"><i class="fa fa-trash"></i></button>
            </div>
          </div>
        `;
        list.appendChild(div);
      });
      localStorage.setItem('aiAssistantTasks', JSON.stringify(state.tasks));
    }

    function toggleDone(index) {
      state.tasks[index].done = !state.tasks[index].done;
      renderTasks();
    }

    function deleteTask(index) {
      state.tasks.splice(index, 1);
      renderTasks();
    }

    /*******************************
     * AI Chat
     *******************************/
    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const query = input.value.trim();
      if (!query) return;
      addChatMessage('user', query);
      input.value = '';

      if (!state.openaiKey) {
        addChatMessage('bot', 'Please set your OpenAI API key in Settings first.');
        return;
      }
      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${state.openaiKey}`,
          },
          body: JSON.stringify({
            model: 'gpt-3.5-turbo',
            messages: [
              { role: 'system', content: 'You are a helpful travel agent assistant. Provide clear, concise answers and prioritise urgent ticketing tasks.' },
              ...chatHistory,
              { role: 'user', content: query },
            ],
            temperature: 0.7,
          }),
        });
        const data = await response.json();
        const reply = data.choices && data.choices.length ? data.choices[0].message.content.trim() : 'No response';
        addChatMessage('bot', reply);
        chatHistory.push({ role: 'user', content: query });
        chatHistory.push({ role: 'assistant', content: reply });
      } catch (err) {
        addChatMessage('bot', 'Error contacting OpenAI API: ' + err.message);
      }
    }

    const chatHistory = [];

    function addChatMessage(sender, text) {
      const container = document.getElementById('chatMessages');
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message ' + sender;
      msgDiv.textContent = text;
      container.appendChild(msgDiv);
      container.scrollTop = container.scrollHeight;
    }

    /*******************************
     * Gmail Integration
     *******************************/
    let gapiInited = false;
    let gisInited = false;
    let gmailTokenClient;
    const GMAIL_DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest';
    const GMAIL_SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';
    // Client ID and API key must be set in the code (replace placeholders below)
    const GMAIL_CLIENT_ID = '<YOUR_GMAIL_CLIENT_ID>'; // replace with your OAuth client ID
    const GMAIL_API_KEY = '<YOUR_GMAIL_API_KEY>'; // replace with your API key

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: GMAIL_API_KEY,
        discoveryDocs: [GMAIL_DISCOVERY_DOC],
      });
      gapiInited = true;
      maybeEnableGmail();
    }

    function gisLoaded() {
      gmailTokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GMAIL_CLIENT_ID,
        scope: GMAIL_SCOPES,
        callback: handleGmailAuth,
      });
      gisInited = true;
      maybeEnableGmail();
    }

    function maybeEnableGmail() {
      const btn = document.getElementById('gmailConnectBtn');
      if (gapiInited && gisInited) {
        btn.disabled = false;
      }
    }

    async function handleGmailAuth(resp) {
      if (resp && resp.access_token) {
        state.integrationTokens.gmail = resp.access_token;
        document.getElementById('gmailStatus').classList.remove('d-none');
        // Fetch tasks from Gmail
        await fetchGmailTasks();
      }
    }

    function connectGmail() {
      gmailTokenClient.callback = handleGmailAuth;
      if (gapi.client.getToken() === null) {
        gmailTokenClient.requestAccessToken({ prompt: 'consent' });
      } else {
        gmailTokenClient.requestAccessToken({ prompt: '' });
      }
    }

    async function fetchGmailTasks() {
      try {
        // List messages with the label "TODO" or flagged (modify as needed)
        const res = await gapi.client.gmail.users.messages.list({ userId: 'me', maxResults: 20, q: 'label:inbox label:todo OR is:starred' });
        const messages = res.result.messages || [];
        for (const msg of messages) {
          const msgDetail = await gapi.client.gmail.users.messages.get({ userId: 'me', id: msg.id });
          const headers = msgDetail.result.payload.headers;
          const subject = headers.find(h => h.name === 'Subject')?.value || 'No subject';
          const snippet = msgDetail.result.snippet;
          // Basic heuristic: if the subject or snippet contains keywords like 'task', 'todo', etc.
          if (/\b(task|todo|due|follow up)\b/i.test(subject + ' ' + snippet)) {
            state.tasks.push({ title: subject, due: null, priority: 'Medium', done: false, source: 'gmail' });
          }
        }
        renderTasks();
        notify('Gmail tasks imported', 'Imported ' + messages.length + ' messages.');
      } catch (err) {
        console.error(err);
        notify('Gmail error', err.message);
      }
    }

    /*******************************
     * Outlook/Microsoft Graph Integration
     *******************************/
    async function connectOutlook() {
      // Outlook authentication must be performed server‑side or using MSAL.js.
      // Here we show a simple prompt to paste an access token. In a real app,
      // use Microsoft’s authentication flow to get a token with Mail.Read scope【297183856141940†L59-L67】.
      const token = prompt('Paste your Microsoft Graph access token (Mail.Read scope)');
      if (token) {
        state.integrationTokens.outlook = token;
        document.getElementById('outlookStatus').classList.remove('d-none');
        await fetchOutlookTasks();
      }
    }

    async function fetchOutlookTasks() {
      try {
        const resp = await fetch('https://graph.microsoft.com/v1.0/me/messages?$top=20', {
          headers: { Authorization: 'Bearer ' + state.integrationTokens.outlook }
        });
        const data = await resp.json();
        for (const message of data.value || []) {
          const subject = message.subject;
          const bodyPreview = message.bodyPreview || '';
          if (/\b(task|todo|due|follow up)\b/i.test(subject + ' ' + bodyPreview)) {
            state.tasks.push({ title: subject, due: null, priority: 'Medium', done: false, source: 'outlook' });
          }
        }
        renderTasks();
        notify('Outlook tasks imported', 'Imported ' + (data.value || []).length + ' messages.');
      } catch (err) {
        console.error(err);
        notify('Outlook error', err.message);
      }
    }

    /*******************************
     * Slack Integration
     *******************************/
    async function connectSlack() {
      // Prompt the user for a Slack token and channel ID. Real implementation
      // should use OAuth 2.0 to authorize and store the token. Ensure the token
      // has the channels:history or relevant scope【398802050782037†L898-L1003】.
      const token = prompt('Enter your Slack bot token (xoxb-...)');
      const channel = prompt('Enter the Slack channel ID to fetch tasks from');
      if (token && channel) {
        state.integrationTokens.slack = { token, channel };
        document.getElementById('slackStatus').classList.remove('d-none');
        await fetchSlackTasks();
      }
    }

    async function fetchSlackTasks() {
      const { token, channel } = state.integrationTokens.slack;
      try {
        const resp = await fetch('https://slack.com/api/conversations.history', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded', Authorization: 'Bearer ' + token },
          body: new URLSearchParams({ channel, limit: 20 }).toString(),
        });
        const data = await resp.json();
        if (!data.ok) throw new Error(data.error);
        for (const msg of data.messages || []) {
          const text = msg.text;
          if (/\b(task|todo|due|follow up)\b/i.test(text)) {
            state.tasks.push({ title: text.slice(0, 50) + '…', due: null, priority: 'Medium', done: false, source: 'slack' });
          }
        }
        renderTasks();
        notify('Slack tasks imported', 'Imported ' + (data.messages || []).length + ' messages.');
      } catch (err) {
        console.error(err);
        notify('Slack error', err.message);
      }
    }

    /*******************************
     * Google Docs Integration
     *******************************/
    async function connectDocs() {
      // Prompt user for an OAuth token with docs.readonly scope and document ID.
      // In production, use Google OAuth flows. The token requires
      // https://www.googleapis.com/auth/documents.readonly or drive scopes【690496299547639†L233-L290】.
      const token = prompt('Enter your Google Docs OAuth access token');
      const docId = prompt('Enter the Google Doc ID to fetch tasks from');
      if (token && docId) {
        state.integrationTokens.docs = { token, docId };
        document.getElementById('docsStatus').classList.remove('d-none');
        await fetchDocsTasks();
      }
    }

    async function fetchDocsTasks() {
      const { token, docId } = state.integrationTokens.docs;
      try {
        const resp = await fetch(`https://docs.googleapis.com/v1/documents/${docId}`, {
          headers: { Authorization: 'Bearer ' + token },
        });
        const data = await resp.json();
        // Traverse the document body to extract text content. We'll look for
        // paragraphs containing TODO markers.
        const body = data.body.content || [];
        body.forEach(elem => {
          if (elem.paragraph && elem.paragraph.elements) {
            const text = elem.paragraph.elements.map(e => e.textRun?.content || '').join('');
            if (/\b(task|todo|due|follow up)\b/i.test(text)) {
              state.tasks.push({ title: text.trim().slice(0, 80) + '…', due: null, priority: 'Medium', done: false, source: 'docs' });
            }
          }
        });
        renderTasks();
        notify('Docs tasks imported', 'Tasks extracted from document.');
      } catch (err) {
        console.error(err);
        notify('Docs error', err.message);
      }
    }

    /*******************************
     * AI prioritisation of tasks
     *******************************/
    async function summariseTasks() {
      if (!state.openaiKey) {
        alert('Please set your OpenAI API key in Settings.');
        return;
      }
      const pending = state.tasks.filter(t => !t.done);
      if (pending.length === 0) {
        alert('No pending tasks to summarise.');
        return;
      }
      const prompt = `You are an assistant helping a travel agent prioritise tasks. Given the following tasks with optional due dates, prioritise them based on urgency and importance and output a concise list.\n\n` + pending.map((t, i) => `${i + 1}. ${t.title}${t.due ? ' (Due: ' + new Date(t.due).toLocaleString() + ')' : ''} Priority: ${t.priority}`).join('\n') + '\n\nReturn the reordered list with a brief explanation.`;
      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${state.openaiKey}`,
          },
          body: JSON.stringify({
            model: 'gpt-3.5-turbo',
            messages: [ { role: 'user', content: prompt } ],
            max_tokens: 300,
          }),
        });
        const data = await response.json();
        const reply = data.choices && data.choices[0] ? data.choices[0].message.content.trim() : 'Unable to summarise.';
        alert('AI Prioritisation:\n\n' + reply);
      } catch (err) {
        alert('Error summarising tasks: ' + err.message);
      }
    }

    /*******************************
     * Event listeners and initialisation
     *******************************/
    document.getElementById('sendChat').addEventListener('click', sendMessage);
    document.getElementById('chatInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });

    document.getElementById('addTaskForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const title = document.getElementById('taskTitle').value.trim();
      const due = document.getElementById('taskDue').value;
      const priority = document.getElementById('taskPriority').value;
      state.tasks.push({ title, due: due || null, priority, done: false });
      document.getElementById('taskTitle').value = '';
      document.getElementById('taskDue').value = '';
      document.getElementById('taskPriority').value = 'Medium';
      renderTasks();
    });

    document.getElementById('settingsForm').addEventListener('submit', (e) => {
      e.preventDefault();
      savePreferences();
      scheduleNotifications();
      alert('Settings saved');
    });

    document.getElementById('gmailConnectBtn').addEventListener('click', connectGmail);
    document.getElementById('outlookConnectBtn').addEventListener('click', connectOutlook);
    document.getElementById('slackConnectBtn').addEventListener('click', connectSlack);
    document.getElementById('docsConnectBtn').addEventListener('click', connectDocs);
    document.getElementById('summariseTasksBtn').addEventListener('click', summariseTasks);

    // Load tasks and preferences on startup
    (function init() {
      loadPreferences();
      const tasks = localStorage.getItem('aiAssistantTasks');
      if (tasks) state.tasks = JSON.parse(tasks);
      renderTasks();
      scheduleNotifications();
    })();
  </script>
</body>
</html>
